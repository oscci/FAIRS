---
title: "FAIRS report, Rounds 1 and 2"
author: "Dorothy V. M. Bishop"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: null
  word_document: 
    reference_docx: word-styles-reference-01.docx
---

<!---  Numerical data only, no free text comments -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(viridis)
require(here)
require(janitor)
require(tidyr)
library(stringr)
require(flextable)
require(explore) #not needed but helps to visualise data
require(DescTools)


```
<!--- https://rmarkdown.rstudio.com/articles_docx.html for page numbers-->



```{r readcleaneddata, echo = F}
datadict <- read.csv('DataDictionary_Rounds_1_2_csv.csv')
#remove the blank rows from data dictionary which are just there for ease of reading in excel.
w<- which(is.na(datadict$column)) 
datadict<-datadict[-w,]
row.names(datadict)<-1:nrow(datadict)

df <- read.csv('FAIRS_Rounds1_2.csv')

```

```{r orderedfactors}
#make ordered factors for mult choice items
ordfac <- function(df,colnum,myorder){
  uniques <- unique(df[,colnum])
  df[,colnum]<-factor(df[,colnum],ordered=TRUE,levels=uniques[myorder])
  return(df)
}

#These are hard-coded : check each column using unique to find how the responses are ordered, then manually reorder
#THIS WILL ONLY WORK WITH DF CREATED FROM THIS CSV IN THIS ORDER!

#NB NA will be included in the unique list, and is omitted here

df<-ordfac(df,colnum = 10, myorder = c(3,1,2))
df<-ordfac(df,colnum = 33, myorder = c(1,2,3))
df<-ordfac(df,colnum = 34, myorder = c(5,4,1,2,3))
df<-ordfac(df,colnum = 39, myorder = c(3,2,1))
df<-ordfac(df,colnum = 40, myorder = c(3,2,1))
df<-ordfac(df,colnum = 64, myorder = c(3,2,1))
df<-ordfac(df,colnum = 65, myorder = c(2,4,1))
df<-ordfac(df,colnum = 87, myorder = c(6,1,4,2,5))
df<-ordfac(df,colnum = 95, myorder = c(4,5,1,2))
df<-ordfac(df,colnum = 96, myorder = c(6,5,4,2,1))

df[,5]<-factor(df[,5])
df[,6]<-factor(df[,6])
```


## Summary of FAIRS Survey, rounds 1 and 2

For background to the survey, please see the protocol here: <https://osf.io/rycqb/>.  
For interim reports from Rounds 1 and 2 that include free text comments please see here: <https://osf.io/mzjsh/>.   


```{r numformat,echo=F}
#Format numbers so they have same n decimal places, even if zero at end
#This returns a string

numformat=function(mynum,ndecimals){
  newnum <- format(round(mynum,ndecimals),nsmall=ndecimals)
  return(newnum)
}

```

```{r myhighlight, echo=F}
addhighlight <- function(myft){
  cutoff1 <- 70 #setting cutoff dynamically doesn't work for some reason, so they are hard coded below
  cutoff2 <- 50
  color4 <- 'red'
  color3 <-'pink'
  color2 <- 'lightblue'
  color1 <- 'cornflowerblue'

#This miscodes any row with 100 in it.  I think this has to do with values being text rather than numeric, (for formatting purposes) but various attempts to fix it have failed.  Need to correct manually

  myft <- highlight(myft, j = 2, i = ~ `S` > 49.999, color = color2)
  myft <- highlight(myft, j = 2, i = ~ `S` > 70.0, color = color1)
  myft <- highlight(myft, j = 2, i = ~ `S` < 50.0, color = color3)
  myft <- highlight(myft, j = 2, i = ~ `S` < 30.0, color = color4)
  
  
  myft <- highlight(myft, j = 3, i = ~ `R` > 49.999, color = color2)
  myft <- highlight(myft, j = 3, i = ~ `R` > 70.0, color = color1)
  myft <- highlight(myft, j = 3, i = ~ `R` < 50.0, color = color3)
  myft <- highlight(myft, j = 3, i = ~ `R` < 30.0, color = color4)
  
  
  
  myft <- highlight(myft, j = 4, i = ~ `O` > 49.999, color = color2)
  myft <- highlight(myft, j = 4, i = ~ `O` > 70.0, color = color1)
  myft <- highlight(myft, j = 4, i = ~ `O` < 50.0, color = color3)
  myft <- highlight(myft, j = 4, i = ~ `O` < 30.0, color = color4)
  
  myft <- highlight(myft, j = 5, i = ~ All > 49.999, color = color2)
  myft <- highlight(myft, j = 5, i = ~ All > 70.0, color = color1)
  myft <- highlight(myft, j = 5, i = ~ All < 50.0, color = color3)
  myft <- highlight(myft, j = 5, i = ~ All < 30.0, color = color4)
  
  return(myft)
} 
```

```{r multchtab, echo=FALSE}
makemc <- function(df,w,groupcol,mycaption){
  rawtab <- table(df[,w],df[,groupcol])
  rawdf<-as.data.frame.matrix(rawtab)
  rawdf$All<-rowSums(rawdf[,1:3])
  sumtab <-as.data.frame.matrix(100*prop.table(as.matrix(rawdf),2))
  sumtab <- numformat(sumtab,1)
  sumtab<-cbind(row.names(sumtab),sumtab)
  names(sumtab) <- c('Multiple choice option','S','R','O','All')
  myft <- flextable(as.data.frame(sumtab))
  
  myft <- addhighlight(myft)
  myft <- set_caption(myft, mycaption)
  myft <- set_table_properties(myft,layout="autofit")
  myft
}
```

```{r percentageagree, echo = FALSE}
#thisrow is 0 for generic report; otherwise specifies the panellist
propagree <- function(df,col1,col2, maxval,groupcol, mycaption){ 
  
  
  w <- col2-col1+1 #N subitems
  thisbit <- as.data.frame(df[,col1:col2])
  
  agreetab<-data.frame(matrix (NA, nrow=w,ncol=5))
  names(agreetab)<-c('Subitem','S','R','O','All')
  myoptions <- 1:maxval
  
  #Check for 5 point scale and collapse extremes
  if(maxval==5){
    myoptions <-c(1.5,3,4.5)
    for(v in 1:w){
      ww<-which(thisbit[,v]==4)
      thisbit[ww,v] <- 5   
      ww<-which(thisbit[,v]==2)
      thisbit[ww,v] <- 1 
    }
  }
  
  # #Check for 4 point scale and add one, so 2 most extreme become 4-5
  # if(maxval==4){
  #   for(v in 1:w){
  #     
  #     thisbit[,v] <- thisbit[,v]  +1
  #     }
  #   }
    
    for (v in 1:w){ #stepping through subitems
      thistab <- table(thisbit[,v],df[,groupcol])
      thistab <- cbind(thistab,table(thisbit[,v])) #last col has All cases
      ptab <- prop.table(thistab,2) #percentage of each response by group (2nd num indicates col percentage rather than row)
   
    agreetab[v,2:5]<-numformat(100*ptab[nrow(ptab),],1)

    agreetab[v,1]<-paste0(LETTERS[v],") ",datadict$name.1[(col1+v-1)])
  
    }

    myft <- flextable(as.data.frame(agreetab))
    myft <- set_caption(myft, mycaption)
    myft <- addhighlight(myft) 
 
    myft <- set_table_properties(myft,layout="autofit")
    return(myft)
}
```



```{r allitems}
for (i in 2:17){
  for (r in 1:2){

  thisbit<-paste0(r,"_item",i)
  thiscaption<-paste0("Round ",r,": Item ",i)
   w<-which(grepl(thisbit,names(df))==TRUE)
   if(length(w)==1){  
 myft<-makemc(df,w,groupcol=6,thiscaption)
   }
   if(length(w)>1){
    col1=min(w)
    col2=max(w)
    myft<-propagree(df,col1,col2, maxval = length(w),groupcol=6,thiscaption)
   }
myft
  }
}
```







## Burdens of serious research misconduct 
### Item 2       
How common is the problem of serious research misconduct? (select one).
Table shows percentages selecting each option in each group.
(For personalised reports, * denotes your response).

```{r item2}
#we use the time 2 categorisation of group for both tables
makemc(df,w=10,groupcol=6,"Round 1: Item 2")
makemc(df,w=65,groupcol=6, "Round 2: Item 2")
Tabla <- table(df$X1_item2, df$X2_item2)
Kendall2 <- KendallTauB(Tabla, conf.level=0.95)

```

### Item 3    
How harmful are the impacts of serious research misconduct to different segments of society? Please code as 1 (low harm) to 5 (strong harm)  



```{r item3, echo=F}

propagree(df,col1=11,col2=15, maxval = 5,groupcol=6,"Round 1: Item 3")
propagree(df,col1=66,col2=69, maxval = 5,groupcol=6,"Round 2: Item 3")
```


## Goals of those responding to serious research misconduct 
### Item 4    
In responding to serious research misconduct, several goals may be considered. 
Please rate how important each of these is, from 1 (unimportant) to 4 (very important) 

```{r item4, echo=F}

#propagree(df,col1=16,col2=19, maxval = 4,groupcol=6,"Round 1: Item 4")
#This one looks wrong - had 4 pt scale - was it reverse coded?  Need to check

propagree(df,col1=70,col2=72, maxval = 5,groupcol=6,"Round 2: Item 4")
```

## Factors hindering academic institutions' response to serious research misconduct 
### Item 5   
Various factors may hinder academic institutions' response to serious research 
misconduct. Please rate the following from 1 (not much of a hindrance) to 5 (substantial hindrance) 


 
For this item, the percentage agreeing was computed after collapsing the two top categories, 4 and 5. The standout result was the very high endorsement of subitem B by the Sleuths.  
 
```{r item5} 

propagree(df,col1=21,col2=28, maxval = 5,groupcol=6,"Round 1: Item 5")
propagree(df,col1=73,col2=79, maxval = 5,groupcol=6,"Round 2: Item 5")
```



## Factors driving serious research misconduct 
### Item 6   
What is the impact of these factors in encouraging researchers to commit serious research misconduct? 
Please rate from 1 (little impact) to 5 (large impact) 

 
```{r item6}
w<-which(grepl('1_item6',names(df))==TRUE)
col1<-min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 1: Item 6")
w<-which(grepl('2_item6',names(df))==TRUE)
col1<-min(w)
col2=max(w)

propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 2: Item 6")

```


## Role of social media   
### Item 7  
On balance, the role of social media in detecting and reporting serious research 
misconduct has been (select one).  
Table shows percentages selecting each option in each group.  

```{r item7}

w<-which(grepl('1_item7',names(df))==TRUE)
makemc(df,w,groupcol=6,"Round 1: Item 7")
w<-which(grepl('2_item7',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 2: Item 7")


```

 


## Reporting serious research misconduct   
### Item 8   
Official channels for reporting misconduct are often slow and obstructive (select one option).   
Table shows percentages selecting each option in each group.  
(For personalised reports, * denotes your response).

```{r item8}
w<-which(grepl('1_item8',names(df))==TRUE)
#makemc(df,w,groupcol=6,"Round 1: Item 8")
propagree(df,w,w, maxval = 5,groupcol=6,"Round 1: Item 8")

w<-which(grepl('2_item8',names(df))==TRUE)
#makemc(df,w,groupcol=6,"Round 2: Item 8")
propagree(df,w,w, maxval = 5,groupcol=6,"Round 2: Item 8")
```

## Models for addressing serious research misconduct 
### Item 9  
In an ideal world where resources are not an issue, which is the most suitable model/system for addressing serious research misconduct? 

```{r item9, echo = F}
w<-which(grepl('1_item9',names(df))==TRUE)
col1=min(w)
col2=max(w)

propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 1: Item 9 - CHECK RANKED")

w<-which(grepl('2_item9',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 2: Item 9")
```



## Role of employers
### Item 10  
Prospective employers should undertake rigorous due diligence and, as far as
possible, check with previous employers to ask if there have been any investigations into serious research misconduct.  


```{r item10, echo=FALSE}
w<-which(grepl('1_item10',names(df))==TRUE)
makemc(df,w,groupcol=6,"Round 1: Item 10")
w<-which(grepl('2_item10',names(df))==TRUE)
makemc(df,w,groupcol=6, "Round 2: Item 10")

```

### Item 11  
Employers, funders and publishers of research should be legally required to share information to support investigations of serious research misconduct.  


```{r item11, echo=FALSE}
w<-which(grepl('1_item11',names(df))==TRUE)
makemc(df,w,groupcol=6,"Round 1: Item 11")
w<-which(grepl('2_item11',names(df))==TRUE)
makemc(df,w,groupcol=6, "Round 2: Item 11")

``` 

## Solutions to serious research misconduct
### Item 12  
Given that we have finite resources, which solutions to serious research misconduct should be prioritised in funding?
Rate the following options from 1 = most preferred, to 5 = least preferred 

```{r item12, echo=F}

w<-which(grepl('1_item12',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 1: Item 12 - CHECK RANKING?")
w<-which(grepl('2_item12',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 2: Item 12")


```

## Role of publishers  
### Item 13 
It is not the responsibility of publishers or journal editors to determine whether serious research misconduct has occurred, but they are responsible for ensuring the literature is decontaminated from erroneous work promptly. 

```{r item13, echo=F}

w<-which(grepl('1_item13',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 1: Item 13")
w<-which(grepl('2_item13',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 2: Item 13")


```

## Whistleblowers and bystanders  
### Item 14  
Please rate your agreement with the following statements about whistleblowers from 1 = strongly disagree to 5 = strongly agree  

```{r item14, echo=F}

w<-which(grepl('1_item14',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 1: Item 14")
w<-which(grepl('2_item14',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 2: Item 14")


```

## When serious research misconduct is confirmed  
### Item 15  
Which of these practices should be options for institutions when serious research misconduct is confirmed.
Please give your rating from 1 = strongly disagree to 5 = strongly agree.


```{r item15, echo=F}

w<-which(grepl('1_item15',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 1: Item 15")
w<-which(grepl('2_item15',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 2: Item 15")

```

## Unintended consequences/barriers to progress  
### Item 16  
Please rate your agreement with the following statements about unintended consequences/barriers to progress from 1 = strongly disagree to 5 = strongly agree  

```{r item16, echo=F}

w<-which(grepl('1_item16',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 1: Item 16")
w<-which(grepl('2_item16',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 2: Item 16")

```

### Item 17  
"One of the likely drivers of trust and distrust in research is the way research institutes, publishers, and funders respond to allegations of research misconduct" (Bouter, 2024)   

### Item 11  
Employers, funders and publishers of research should be legally required to share information to support investigations of serious research misconduct.  


```{r item17, echo=FALSE}
w<-which(grepl('1_item17',names(df))==TRUE)
makemc(df,w,groupcol=6,"Round 1: Item 17")

w<-which(grepl('2_item17',names(df))==TRUE)
col1=min(w)
col2=max(w)
propagree(df,col1,col2, maxval = 5,groupcol=6,"Round 2: Item 17")

``` 





the end

